<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: linux | shigeponが関心のある技術情報など]]></title>
  <link href="http://blog.shigepon.info/blog/categories/linux/atom.xml" rel="self"/>
  <link href="http://blog.shigepon.info/"/>
  <updated>2015-07-31T16:58:21+09:00</updated>
  <id>http://blog.shigepon.info/</id>
  <author>
    <name><![CDATA[shigepon]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[なでしこ2でradikoの録音をやってみた]]></title>
    <link href="http://blog.shigepon.info/blog/2015/07/19/record-radiko-with-nadesiko2/"/>
    <updated>2015-07-19T17:22:00+09:00</updated>
    <id>http://blog.shigepon.info/blog/2015/07/19/record-radiko-with-nadesiko2</id>
    <content type="html"><![CDATA[<p>ネット上でラジオを聞けるサービス<a href="http://radiko.jp/">radiko</a>の録音ソフトが調子悪くなったので、自分で作ってみるかーとやってみたら出来たのでメモ。OSはUbuntu 12.04で、cui環境で行った。</p>

<p>参考：</p>

<ul>
<li><a href="https://gist.github.com/matchy2/3956266">簡易Radiko録音スクリプト</a></li>
<li><a href="http://d.hatena.ne.jp/zariganitosh/20130124/rtmpdump_radiko_access">rtmpdumpでradikoにアクセスする手順 &ndash; ザリガニが見ていた&hellip;。</a></li>
<li><a href="http://lifeonubuntu.com/ubuntu-missing-add-apt-repository-command/">Ubuntu Missing add-apt-repository command</a></li>
<li><a href="http://www.ubuntugeek.com/how-to-install-swftools-in-ubuntu-12-0411-10-using-ppa.html">How to install SWFTools in ubuntu 12.04/11.10 using PPA | Ubuntu Geek</a></li>
</ul>


<p>Radiko録音スクリプトをまず参考にしたが、実際に手順を手作業で追いたかったので、参考記事を見ながら再現してみた。するとまずswfextractコマンドが無くてつまずく。ぐぐるとaptのリポジトリを追加してインストールする必要があるらしい。しかもリポジトリ追加用コマンドも無いのでインストールする必要があった。swfextractを使えるようになるまでの手順は以下の通り</p>

<p><code>sh
$ sudo aptitude install software-properties-common python-software-properties
$ sudo add-apt-repository ppa:guilhem-fr/swftools
$ sudo aptitude update
$ sudo aptitude install swftools
</code></p>

<p>あとは参考ページの手順通りで録音出来た。<a href="http://www.dcc-jpl.com/foltia/wiki/radikomemo">radikomemo &ndash; foltia &ndash; Trac</a>で放送局のid（xml取得に使ったりする）をチェックした。</p>

<p>で、あとは一連の処理をなぞるスクリプトを書くだけ。pythonとかはググればあるので、なでしこ2でやってみた。</p>

<p><a href="https://gist.github.com/shigepon/01acb8686e6df6accce2">record_radiko.nako</a></p>

<p>gistを初めて使うので、こんなやり方で良いのかちょっと分からないけどこんな感じ。wgetとかddとかコマンドをそのまま使ってるので、windowsでは動かないはず。なでしこ2では7/19時点ではpostでヘッダー指定するとか出来ないので、こうせざるを得ない。</p>

<p>なでしこ2の一例ということで。ちなみにこれ作るのに3時間かかった。うち1時間半がググってインストールして手作業で動作確認に使って、1時間は休憩に使った。エラー処理とかtmpファイルの処理とか全然やってない適当コードですんません＞＜。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jenkinsでなでしこ2をCIする]]></title>
    <link href="http://blog.shigepon.info/blog/2015/05/08/nadesiko2-continuous-integration-with-jenkins/"/>
    <updated>2015-05-08T09:19:18+09:00</updated>
    <id>http://blog.shigepon.info/blog/2015/05/08/nadesiko2-continuous-integration-with-jenkins</id>
    <content type="html"><![CDATA[<p><a href="http://blog.shigepon.info/blog/2015/05/05/nunit-console-test-for-nadesiko2/">なでしこ2をubuntu cuiでテストする &ndash; shigeponが関心のある技術情報など</a>
までやったので、CIできると便利かなと思ってやってみた。と言いつつ、単にやってみたかっただけ。mono developとかvisual studio使って開発する場合も同じように出来ると思う。例によって環境はUbuntu 12.04</p>

<p>参考：</p>

<ul>
<li><a href="http://d.hatena.ne.jp/Crest/20121220/1356023823">.NETとJenkinsで始めるCI開発 &ndash; CREST’S WEBLOG</a></li>
<li><a href="http://blog.bekijkhet.com/2013/01/create-mono-c-buildserver-using-jenkins.html">Create a Mono C# Buildserver using Jenkins and GitHub ~ BroersA Blog</a></li>
</ul>


<h2>1. Jenkinsインストール</h2>

<p>(略) 追記するかも？</p>

<!-- more -->


<h2>2. Jenkins設定</h2>

<!-- more -->


<h3>一般</h3>

<p>(略) 追記するかも？</p>

<h3>C#関連</h3>

<p>Jenkins > Jenkinsの管理 > プラグインの管理 > 利用可能(タブ)</p>

<p>からプラグインをインストールする。インストールするプラグインは</p>

<ul>
<li>GIT Plugin</li>
<li>MSBuild Plugin</li>
<li>NUnit plugin</li>
</ul>


<p>Jenkins > Jenkinsの管理 > システム設定</p>

<p>から</p>

<p>MSBuildの項目を編集。</p>

<ul>
<li>インストール済みMSBuild&hellip;をクリック</li>
<li>name</li>
<li>適当（とりあえず「mono」とした）</li>
<li>Path to MSBuild</li>
<li>/usr/bin/xbuild  (Warning出るけど気にしない)</li>
<li>Default Parameters</li>
<li>なし(Debugでビルドするかとか指定したりするかも。)</li>
<li>適用ボタンを押す</li>
</ul>


<p>Gitの項目は編集したか覚えてないけど</p>

<ul>
<li>Path to Git executable</li>
<li>/usr/bin/git</li>
</ul>


<p>くらいやっとけばいいかも？　</p>

<h2>3. プロジェクト作成</h2>

<p>Jenkins > 新規ジョブ作成　から</p>

<ul>
<li>ジョブ名</li>
<li>適当(nadesiko2とか付けてみた)</li>
<li>フリースタイル・プロジェクトのビルドを選択</li>
<li>OKボタンを押す</li>
</ul>


<h2>4. プロジェクト設定</h2>

<p>プロジェクトの設定画面に移動するので編集。Jenkins > プロジェクト(今回はnadesiko2) > 設定　からいつでも編集可能。</p>

<ul>
<li>ソースコード管理</li>
<li>Gitを選択</li>
<li>Repository URL</li>
<li> なでしこ2のリポジトリの場所。今回は<a href="http://blog.shigepon.info/blog/2015/05/01/develop-nadesiko2-on-ubuntu-cui/">ubuntuのcui環境でなでしこ2をビルドする &ndash; shigeponが関心のある技術情報など</a>の続きなので/home/username/nadesiko2</li>
<li>Branches to build</li>
<li> なでしこ2では変更点はpull requestする予定なので、pull requestする時のブランチを指定した。ここは色んな設定がありえる。</li>
<li>ビルド・トリガ</li>
<li>SCMをポーリングを選択</li>
<li>スケジュール</li>
<li> H/30 * * * * (大体30分おき)</li>
<li>ビルド</li>
<li>ビルド手順の追加 > Build a Visual Studio project or solution using MSBuild</li>
<li>Build a Visual Studio project or solution using MSBuildの設定</li>
<li> MSBuild Version

<ul>
<li>monoを選択</li>
</ul>
</li>
<li> MSBuild Build File

<ul>
<li>cnakoのソリューションファイルとしてNako2_CNako.slnを指定した。プラグインのソリューションファイルでも出来ると思う</li>
</ul>
</li>
<li>ビルド手順の追加 > シェルの実行(Windowsだと多分Windowsバッチコマンドの実行)</li>
<li>シェルの実行</li>
<li> nunit-console $WORKSPACE/CNako2Test/bin/Debug/CNako2Test.dll -xml cnako2test.xml -noshadow</li>
<li>ビルド後の処理</li>
<li>ビルド後の処理の追加 > Publish NUnit test result report</li>
<li>cnako2test.xml</li>
</ul>


<h2>5. 実行</h2>

<p>Jenkins > プロジェクト(今回はnadesiko2)
で、ビルド実行をクリックすると実行してくれる。あと、gitの指定したブランチでコミットした後もこの設定の場合30分おきにコミットをチェックしてビルドを実行してくれる。まだまだテストが通ってない部分もあるので、結果は失敗になるけど、とりあえずこれで進められる。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[なでしこ2をubuntu cuiでテストする]]></title>
    <link href="http://blog.shigepon.info/blog/2015/05/05/nunit-console-test-for-nadesiko2/"/>
    <updated>2015-05-05T23:02:32+09:00</updated>
    <id>http://blog.shigepon.info/blog/2015/05/05/nunit-console-test-for-nadesiko2</id>
    <content type="html"><![CDATA[<p><a href="http://blog.shigepon.info/blog/2015/05/01/develop-nadesiko2-on-ubuntu-cui/">ubuntuのcui環境でなでしこ2をビルドする</a>の続きで、cui環境でなでしこ2のテストを実行してみる。</p>

<p>cui環境でnunitを実行するには<a href="http://www.nunit.org/index.php?p=nunit-console&amp;r=2.5.10">nunit-console</a>を使う。なでしこ2のテストを実行するにはテスト関連のdllをnunitで実行すると良い。コマンドはなでしこ2をインストールしたディレクトリでこんな感じ。</p>

<p><code>sh
$ nunit-console CNako2Test/bin/Debug/CNako2Test.dll
</code></p>

<p>プラグインのテスト(NakoPluginTest)プロジェクトでは外部ファイルを利用するので</p>

<p><code>sh
$ nunit-console NakoPluginTest/bin/Debug/NakoPluginTest.dll
</code></p>

<!-- more -->


<p>だと、外部ファイルを読み込むテスト（例えばTest_read）で、Could not find fileと怒られる。なので、コマンドにnoshadowオプションを付ける。</p>

<p><code>sh
$ nunit-console -noshadow NakoPluginTest/bin/Debug/NakoPluginTest.dll
</code></p>

<p>とすると、外部ファイルを読み込んでくれる。
これでcui環境でなでしこ2をビルドからテストまで出来る。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ubuntuのcui環境でなでしこ2をビルドする]]></title>
    <link href="http://blog.shigepon.info/blog/2015/05/01/develop-nadesiko2-on-ubuntu-cui/"/>
    <updated>2015-05-01T08:23:00+09:00</updated>
    <id>http://blog.shigepon.info/blog/2015/05/01/develop-nadesiko2-on-ubuntu-cui</id>
    <content type="html"><![CDATA[<p>今までmono developでなでしこ2をビルド、テストして、cui環境にアップロードしてたんだけど、面倒になってきたのでcui環境で直接ビルド、テストしてみようと思ったのでついでに開発を始める段階からメモしてみる。</p>

<p>環境はubuntu 12.04とするが、上位バージョンでも問題無いはず</p>

<h1>mono環境の準備</h1>

<p>mono-develをインストールしたらmono関連で必要なものは勝手にインストールされたような気がする。ついでに<a href="http://blog.shigepon.info/blog/2014/08/20/vb-not-work-on-ubuntu/">VisualBasicが動かない件</a>にあるように、mono-vbnc、あとはnunitのインストール</p>

<p><code>sh
$ aptitude install mono-devel mono-vbnc nunit
</code></p>

<!-- more -->




<!-- more -->


<h1>なでしこ2リポジトリを取得</h1>

<p><a href="http://it.slashdot.jp/story/15/03/13/0340256/">Google Codeが2016年1月に閉鎖される</a>ので、なでしこ2のリポジトリはgithubに移動している。</p>

<p>なので、リポジトリの取得はgit cloneでいける。kujirahandさんのリポジトリをcloneするなら</p>

<p><code>sh
$ git clone https://github.com/kujirahand/nadesiko2.git
</code></p>

<p>shigeponがfolkしたリポジトリなら</p>

<p><code>sh
$ git clone https://github.com/shigepon/nadesiko2.git
</code></p>

<p>で、カレントディレクトリにnadesiko2ディレクトリが出来て、その下にプロジェクト1式が入っている。中にはソリューションが3つあり、それぞれ</p>

<ul>
<li>Nako2_CNako.sln → cui環境で動かすなでしこ2(cnako)関連</li>
<li>Nako2_Plugins.sln → なでしこ2のプラグイン関連</li>
<li>Nako2_Plugins_Office.sln → なでしこ2のOffice関係プラグイン</li>
</ul>


<p>のソリューションである。今回は\/home\/usernameディレクトリ上でcloneすると考える</p>

<h1>おもむろにビルド</h1>

<p>kujirahandさんのリポジトリをcloneしたとして、とりあえず何もせずにCNakoのソリューションをビルドしてみると</p>

<p><code>sh
$ xbuild Nako2_CNako.sln
...
NakoPluginArrayTest.cs(9,7): error CS0246: The type or namespace name `NUnit' could not be found. Are you missing a using directive or an assembly reference?
...
</code></p>

<p>みたいなエラーメッセージを出してビルド出来ない。一方でプラグイン関連のソリューションは</p>

<p>```sh
$ xbuild Nako2_Plugins.sln
&hellip;</p>

<pre><code>18 Warning(s)
 0 Error(s)
</code></pre>

<p>Time Elapsed 00:00:06.1095450
```</p>

<p>と出て、エラー無くビルド出来る。この違いはそれぞれのソリューションで参照しているテストプロジェクトにnunitへの参照パスが入っているかどうかの違いだったので、NakoPluginTest/NakoPluginTest.csprojを参考にしてCNakoTest/CNakoTest.csprojの</p>

<p><code>
&lt;Reference Include="nunit.framework.extensions, ..." /&gt;
</code></p>

<p>行に３行追記する</p>

<p>```xml
   <Reference Include="nunit.framework"></p>

<pre><code>   &lt;HintPath&gt;..\..\..\..\usr\lib\mono\gac\nunit.framework\2.5.10.0__96d09a1eb7f44a77\nunit.framework.dll&lt;/HintPath&gt;
</code></pre>

<p>   </Reference>
```</p>

<p>で、再度ビルドするとビルド出来た。shigeponのリポジトリには修正したものをアップしておくのでそのままビルド出来ると思う。パスはリポジトリをcloneするディレクトリによっては変更しないといけないと思う。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[突然サーバエラーが頻発したので、調べてみたらエラーログが原因だった]]></title>
    <link href="http://blog.shigepon.info/blog/2015/03/03/error-log-make-php-error/"/>
    <updated>2015-03-03T09:56:56+09:00</updated>
    <id>http://blog.shigepon.info/blog/2015/03/03/error-log-make-php-error</id>
    <content type="html"><![CDATA[<p>参考：<a href="http://zapanet.info/blog/item/2489">PHPのエラーログが肥大してPHPが動かなくなった話</a></p>

<p>ある日、運用しているサービスがサーバエラーを頻出しだしたので、調べてみた。環境はUbuntu、nginx、php-fpm、postgresql。</p>

<ul>
<li>他のサーバへのdbアクセスがおかしくなったのかと思い、他の方法でdbアクセス→問題無し</li>
<li>サービスを色々再起動してみた。→変化なし</li>
<li>サーバを再起動。しばらくエラーでないが、しばらくするとエラーががが</li>
<li>php-fpmを再起動。しばらくエラーでないが、しばらくするとエラーががが</li>
<li>php周りかなと思ったので、phpのログを開く→開かない！</li>
<li>良く見たらphp-fpmのログが2GB超えてた。ナンテコッタイ。</li>
<li>ログを退避して、ローテーション設定して改めてphp-fpmを再起動したら直った。めでたしめでたし。</li>
</ul>


<p>メモがてらローテーション設定を書いておく</p>

<!-- more -->


<p>/etc/logrotate.d/php.conf
<code>
/path/to/php5-fpm.log {
  daily
  missingok
  rotate 52
  compress
  delaycompress
  notifyempty
  create 0644 group username
  dateext
}
</code>
エラーチェックテストはこんな感じ
<code>sh
logrotate -dv /etc/logrotate.d/php.conf
</code></p>
]]></content>
  </entry>
  
</feed>
