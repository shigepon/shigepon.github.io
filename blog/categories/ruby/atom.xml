<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: ruby | shigeponが関心のある技術情報など]]></title>
  <link href="http://blog.shigepon.info/blog/categories/ruby/atom.xml" rel="self"/>
  <link href="http://blog.shigepon.info/"/>
  <updated>2016-02-25T09:36:40+09:00</updated>
  <id>http://blog.shigepon.info/</id>
  <author>
    <name><![CDATA[shigepon]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[fluent-plugin-groongaをインストールして動かすまでをAnsibleでやってみた]]></title>
    <link href="http://blog.shigepon.info/blog/2016/01/23/install-and-setting-up-fluentd-pluhin-groonga-using-ansible/"/>
    <updated>2016-01-23T14:32:43+09:00</updated>
    <id>http://blog.shigepon.info/blog/2016/01/23/install-and-setting-up-fluentd-pluhin-groonga-using-ansible</id>
    <content type="html"><![CDATA[<p>ログ集計に何使うか迷ったんだけど、fluentdに<a href="https://github.com/groonga/fluent-plugin-groonga">fluent-plugin-groonga</a>ってのがあったのでfluentdを使ってgroongaにログを集計していくとこまでをやった。rbenvから色々やろうとしたら面倒だった。</p>

<h2>rbenvを使う</h2>

<p>バージョン管理が面倒なので、やっぱrbenv使わないといかんっしょと思ってやった。<a href="http://qiita.com/katsuhiko/items/56935225754a90d58314">Ansible と Vagrant を使って Rails 開発環境（Ubuntu + rbenv + MySQL5.6 + node.js）を構築する &ndash; Qiita</a>を参考にして変数を適当にしたりsudoのとこを変更したりして出来た</p>

<!-- more -->


<h2>```yml</h2>

<ul>
<li>hosts: all
user: hoge
tasks:

<ul>
<li>name: Install dependencies for rbenv
sudo: yes
apt: name= state=latest
with_items:

<ul>
<li>git</li>
</ul>
</li>
<li>name: Install rbenv
git: repo=<a href="https://github.com/sstephenson/rbenv.git">https://github.com/sstephenson/rbenv.git</a> dest=~/.rbenv</li>
<li>name: Add ~.rbenv/bin to PATH
lineinfile: >
  dest=&ldquo;~/.bashrc&rdquo;
  line=&ldquo;export PATH=$HOME/.rbenv/bin:$PATH&rdquo;</li>
<li>name: Eval rbenv init in ~/.bashrc
lineinfile: >
  dest=&ldquo;~/.bashrc&rdquo;
  line=&lsquo;eval &ldquo;$(rbenv init &ndash;)&rdquo;&rsquo;</li>
<li>name: Install dependencies for ruby-build (see. <a href="https://github.com/sstephenson/ruby-build/wiki">https://github.com/sstephenson/ruby-build/wiki</a>)
apt: name= state=latest
with_items:

<ul>
<li>autoconf</li>
<li>bison</li>
<li>build-essential</li>
<li>libssl-dev</li>
<li>libyaml-dev</li>
<li>libreadline6-dev</li>
<li>zlib1g-dev</li>
<li>libncurses5-dev</li>
<li>libffi-dev</li>
<li>libgdbm3</li>
<li>libgdbm-dev</li>
</ul>
</li>
<li><p>name: Install ruby-build as rbenv plugin
git: repo=<a href="https://github.com/sstephenson/ruby-build.git">https://github.com/sstephenson/ruby-build.git</a> dest=~/.rbenv/plugins/ruby-build</p></li>
<li><p>name: Check if version is installed ruby
shell: &ldquo;~/.rbenv/bin/rbenv versions | grep &rdquo;
register: rbenv_check_install
changed_when: False
ignore_errors: yes</p></li>
<li><p>name: Install ruby
command: &ldquo;~/.rbenv/bin/rbenv install &rdquo;
when: rbenv_check_install|failed</p></li>
<li><p>name: Check if version is the default ruby version
shell: &ldquo;~/.rbenv/bin/rbenv version | grep &rdquo;
register: rbenv_check_default
changed_when: False
ignore_errors: yes</p></li>
<li><p>name: Set default ruby version
command: &ldquo;~/.rbenv/bin/rbenv global &rdquo;
when: rbenv_check_default|failed</p></li>
</ul>
</li>
</ul>


<p>```</p>

<p>rbenv_ruby_versionはインベントリファイルで設定しておく。</p>

<p>shellのところrbenvだけにしたら何回やってもエラーで止まってしまった。なので結局rbenvはフルパス指定にした。bashrcに書いた分その後色々やった時に書いたので.profileでも良いかも知れない。</p>

<h2>fluentdのインストール</h2>

<p>こっから面倒だった。</p>

<p>```yml</p>

<pre><code>- name: Gem install fluentd
  gem: name=
   executable=~/.rbenv/versions//bin/gem user_install=no
  with_items:
    - fluentd
    - fluent-plugin-groonga
</code></pre>

<p>```</p>

<p>たったこれだけ書くのに2時間くらい掛かったorz。fluentdをインストールする前にtd-agentから何とかならないか試したり、gemがなかなかrbenvでインストールしたバージョンになってくれなかったり、fluentdが変な場所にインストールされたり・・・でも結論としてはこれでおk。フルパス指定とuserinstall=noがポイントかな。</p>

<h2>fluentdの設定</h2>

<p>設定やったこと無かったので、ここが手探りになるのは仕方ない。includeのパスを間違えてて設定を読み込めないとか色々しょーもないハマりをした。ログが正しく送られてるかどうかはsourceのタグをdebug.accessに変えて、デバッグ表示させてtailがちゃんとされているか確認→実際にlog.accessでやってみるという手順で行った</p>

<p>```yml
&ndash; name: setup fluentd dir</p>

<pre><code>  command: ~/.rbenv/versions//bin/fluentd --setup /path/to/fluent/config/file
- name: set fluent.conf
  lineinfile: dest=/path/to/fluent/config/file/fluent.conf insertafter=EOF line="@include conf.d/*" state=present
- name: create conf.d folder
  file: path=/path/to/fluent/config/file/conf.d state=directory
- name: copy groonga.fluentd.conf
  copy: src=groonga.fluentd.conf dest=~/path/to/fluent/config/file/conf.d
</code></pre>

<p>```</p>

<p>```xml
<source></p>

<pre><code>type tail
format ltsv
tag log.access
path /path/to/log/file
pos_file /path/to/pos/file
</code></pre>

<p></source>
<match log.*></p>

<pre><code>type groonga
store_table logs
host xxx.xxx.xxx.xx
port xxxxx
</code></pre>

<p></match>
```
としてIPがxxx.xxx.xxx.xxでポートがxxxxxのところにgroongaを用意すると勝手にフィールドとか色々作ってログを保存してくれるようになる。ちなみにfluentdの開始コマンドは</p>

<p><code>sh
$ fluentd -c /path/to/fluent/config/file -vv &amp;
</code></p>

<p>とした。</p>

<p>とりあえずここまでで十分ハマった。</p>

<h2>td-agentは使わない</h2>

<p>使用OSがubuntuなので、td-agentを使ってみたんだが、rbenv上のgemでインストールしたfluent-plugin-groongaを読み込む方法が最後まで分かんなかったので使わないことにした。td-agentだとserveceコマンドでリスタートとかやってくれるので楽なんだけどなー。</p>

<p>参考：<a href="http://mhag.hatenablog.com/entry/2014/07/04/151415">Ubuntu 14.04 LTS に Fluentd をインストールする &ndash; ´・ω・)＜ときどき書くよ</a>, <a href="http://qiita.com/h5y1m141@github/items/74029cab9706971c8dbe">Rubyが参照してるgemのパスやインストール済gemを確認する方法 &ndash; Qiita</a>, <a href="http://qiita.com/groonga/items/5c674be9daf25054c14c">Fluentdで集めたデータをGroongaに格納する方法 &ndash; Qiita</a>, <a href="http://chocoby.jp/blog/2013/03/05/fluentd-ltsv/">fluentd で LTSV がサポートされたのでメモ &ndash; 暇人じゃない</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[find by sqlでプリペアードステートメントを使う]]></title>
    <link href="http://blog.shigepon.info/blog/2014/05/28/use-prepared-statement-in-find-by-sql/"/>
    <updated>2014-05-28T08:19:12+09:00</updated>
    <id>http://blog.shigepon.info/blog/2014/05/28/use-prepared-statement-in-find-by-sql</id>
    <content type="html"><![CDATA[<p>ActiveRecordは便利なのかどうか知らないけど、allなどのメソッドで:conditionとかで?を使うことが出来る。だけど、sqlを直接打ちたいケースは必ず出てくるので、その時に?使いたいなと思ったけど、なかなか例文が無かった。</p>

<p>んで結局こうするといいみたい。</p>

<p><code>rb
@results = Model.find_by_sql(["select * from hoge where fuga=?","hage"])
</code></p>

<p>しかし他にも直接sqlを実行する方法があって、</p>

<p><code>rb
ActiveRecord::Base.connection.raw_connection.exec("select * from hoge where fuga = :1", 'hage')
</code></p>

<!-- more -->


<p>こんな書き方も出来るらしい。ActiveRecord::Base.connectionでは無理らしい。うーむ。むか〜しからRailsはちょっとレールからはずれるととたんに難しくなるんだなー。やる気が減って来た＞＜。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Railsでurl forを使ったらshows proxy passで設定したURLになってしまう件]]></title>
    <link href="http://blog.shigepon.info/blog/2014/05/05/rails-url-for-shows-proxy-pass/"/>
    <updated>2014-05-05T14:00:54+09:00</updated>
    <id>http://blog.shigepon.info/blog/2014/05/05/rails-url-for-shows-proxy-pass</id>
    <content type="html"><![CDATA[<p>Nginx, Unicorn, Rails4でurl_forを使ったら変なURLになってしまったので対処法を書いておく</p>

<p>Ninxで</p>

<p><code>
server hoge.com;
proxy_pass http://upstream;
</code></p>

<p>のような設定をしているとurl_forで</p>

<p><code>
http://hoge.com
</code></p>

<!-- more -->


<p>となってほしいところが</p>

<p><code>
http://upstream
</code></p>

<p>となってしまうので、ググって対処を調べた。</p>

<p><a href="http://stackoverflow.com/questions/5834025/how-to-preserve-request-url-with-nginx-proxy-pass">ruby &ndash; How to preserve request url with nginx proxy_pass &ndash; Stack Overflow</a>を参考にして</p>

<p><code>
proxy_set_header Host http://hoge.com
</code></p>

<p>を追記したら上手く動いた。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Capistrano3でbitbucketからデプロイしようとしたらハマった話]]></title>
    <link href="http://blog.shigepon.info/blog/2014/05/04/capistrano3-shows-error-when-deploy-from-bitbucket/"/>
    <updated>2014-05-04T10:04:00+09:00</updated>
    <id>http://blog.shigepon.info/blog/2014/05/04/capistrano3-shows-error-when-deploy-from-bitbucket</id>
    <content type="html"><![CDATA[<p>まだデプロイ作業を途中までしか確認していないので、とりあえずハマったポイントを書いておく。
 デプロイ作業をテストしてみたらこんなエラーが出た</p>

<p><code>sh
$ bundle exec cap production deploy:check
 INFO [5f874a7e] Running /usr/bin/env mkdir -p /tmp/hoge/ on fuga
DEBUG [5f874a7e] Command: /usr/bin/env mkdir -p /tmp/hoge/
 INFO [5f874a7e] Finished in 0.321 seconds with exit status 0 (successful).
DEBUG Uploading /tmp/hoge/git-ssh.sh 0.0%
 INFO Uploading /tmp/hoge/git-ssh.sh 100.0%
 INFO [c2bf6ab8] Running /usr/bin/env chmod +x /tmp/hoge/git-ssh.sh on fuga
DEBUG [c2bf6ab8] Command: /usr/bin/env chmod +x /tmp/hoge/git-ssh.sh
 INFO [c2bf6ab8] Finished in 0.031 seconds with exit status 0 (successful).
DEBUG [ef8c5c38] Running /usr/bin/env git ls-remote -h git@bitbucket.org:fuga/hoge.git on fuga
DEBUG [ef8c5c38] Command: ( GIT_ASKPASS=/bin/echo GIT_SSH=/tmp/hoge/git-ssh.sh /usr/bin/env git ls-remote -h git@bitbucket.org:fuga/hoge.git )
DEBUG [cb27da31]    Error reading response length from authentication socket
DEBUG [ef8c5c38]    Permission denied (publickey).
DEBUG [ef8c5c38]    
DEBUG [ef8c5c38]    fatal: The remote end hung up unexpectedly
DEBUG [ef8c5c38]    
DEBUG [ef8c5c38] Finished in 2.287 seconds with exit status 128 (failed).
</code></p>

<!-- more -->


<p>うげげ。gitで鍵認証のエラー出てるわ。とりあえずbitbucketに公開鍵を登録してみた。
 <a href="http://morizyun.github.io/blog/ssh-key-bitbucket-github/">SSH認証キーをBitbucket/GitHubに設定しよう！ [Mac簡単手順] &ndash; 酒と泪とRubyとRailsと</a>の通りに登録したら出来た。~/.ssh/configに秘密鍵を追加して</p>

<p><code>sh
Host bitbucket.org
  HostName bitbucket.org
  IdentityFile ~/.ssh/id_rsa
  User git
  TCPKeepAlive yes
  IdentitiesOnly yes
</code></p>

<p> じゃあ再度デプロイをテストしてみたら・・・同じエラーが出た。
色々試行錯誤して、「Error reading response length from authentication socket」でググった結果、ssh_agentが動いてないことが判明したので</p>

<p><code>sh
$ eval `ssh-agent -s`
$ ssh-add ~/.ssh/id_rsa
</code></p>

<p>としてデプロイをテストしたら無事動いた。めでたしめでたし。でも一旦ログアウトしたりするとssh-agentに接続しないとまた同じエラーが出た。ssh-agentへの接続方法は<a href="http://tipspc.blogspot.jp/2010/02/ssh-agent.html">PC便利帳: ssh-agentを使用したパスワードなしの接続</a>を参考にして</p>

<p>```sh
$ ps ax | grep ssh-agent
$ ls /tmp | grep ssh
$ SSH_AUTH_SOCK=/tmp/ssh-XXXXX1111/agent.1111; export SSH_AUTH_SOCK;
$ SSH_AGENT_PID=2222; export SSH_AGENT_PID;
````</p>

<p>とやれば接続できて、デプロイできた。
 さらに実際にデプロイすると下のようにエラーでまくった。</p>

<h2>capistrano3でbundle exec cap production deloyしようとしたらエラーが出まくる</h2>

<p>Gemfileから色々省いてたらエラーが出まくる</p>

<ul>
<li>rubyが指定されてない（rbenvが足りない）</li>
<li>uglifierが無いとかsassが足りないとか</li>
<li>いちいちGemfile.lockをアップデートしないとエラー出る</li>
</ul>


<p>rbenvはcapistrano-rbenvをGemfileに追加して、Capfileにcapistrano/rbenvを指定して、config/deploy.rbに</p>

<p><code>rb
set :rbenv_ruby, '2.1.0'
</code></p>

<p>とか何とか設定するとおk。</p>

<p>uglifierとかsassとかproductionを指定した場合に使うような設定になってるみたいい（config/environments/production.rb）。とりあえずuglifierとかsassとかcofee-railsとか色々Gemfileに入れておけばエラーでなかった。</p>

<h2>デプロイした後でcss関連でエラーが出た</h2>

<p>sassが足らないと言われた。sass使わないので、sassが関わるファイル（app/assets/stylesheets内のscssファイル）を消すとエラーは消えた</p>

<h2>productionモードでデプロイすると、cssやjsを読み込んでくれない</h2>

<p>config/environments/production.rbに次の行を追記</p>

<p><code>rb
 config.assets.compile = true
 config.assets.precompile = ['*.js','*.css','*.css.erb']
</code></p>

<p>参考<a href="http://stackoverflow.com/questions/18700219/rails-4-assets-not-loading-in-production">ruby &ndash; Rails 4: assets not loading in production &ndash; Stack Overflow</a>
すると解決した。なんかバッドノウハウみたいでやだ。</p>

<h2>productionモードでunicornが起動してくれない</h2>

<p>capistranoとは関係なかったけどcapistrano関連と思い込んでたのでメモ。capistranoの設定にミスがあると思って苦しんでたけど、単にunicornのオプションを指定してなかったのが悪かった。</p>

<p><code>sh
$ bundle exec unicorn_rails -E production
</code></p>

<p>でおkだった。</p>

<p>Capistranoは確かに便利なんだけど、なんかハマりポイントが多いような印象。
バージョン変わって設定方法も変わったみたいだし。最初のハードルが高い感じがする。慣れたら楽になるのかな。</p>

<h2>capistrano3でunicornの再起動に失敗する</h2>

<p><a href="http://qiita.com/satococoa/items/9b0cc416ffc042680b9b">unicorn + rails 用 Capistrano 3 の設定ファイル &ndash; Qiita</a>と<a href="http://blog.dealforest.net/2014/02/failed_restart_unicorn_with_capistrano3/">Capistrano3 で Unicorn の再起動に失敗したのを対応したメモ | Supernova</a>が参考になった。</p>

<p>でもrestartでちゃんと再起動して修正箇所が反映しない。stopしてstartしないと。うーん。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[nginx,unicornをさくらvpsにインストールしてrailsアプリを手動でデプロイしてみる]]></title>
    <link href="http://blog.shigepon.info/blog/2014/05/02/use-nginxand-unicorn-on-sakura-vps/"/>
    <updated>2014-05-02T15:10:23+09:00</updated>
    <id>http://blog.shigepon.info/blog/2014/05/02/use-nginxand-unicorn-on-sakura-vps</id>
    <content type="html"><![CDATA[<p>さくらvpsのUbuntu12.04にnginxとunicornをインストールしてローカル環境に作ったRailsアプリを手動でアップロードして表示させてみた。何となくユニコーンって名前が好きなので、unicornを使うことにした。</p>

<h2>nginxインストール</h2>

<p>nginxは本当は手動でインストールするのがいいんだろうけど、面倒なので</p>

<p><code>sh
$ sudo aptitude install nginx
</code></p>

<p>でインストール</p>

<h2>unicornインストール</h2>

<!-- more -->


<p>rubyとかbundlerとかが必要なので、無い場合は<a href="http://blog.shigepon.info/blog/2014/02/26/rails-startup/">Ruby on Railsを入れてみた</a>に書いた通りにインストール。unicornはGemfileに</p>

<p><code>
gem "unicorn"
</code></p>

<p>と追記して</p>

<p><code>sh
$ bundle install -path vendor/bundle
</code></p>

<p>でインストール出来る。要らないかもしれないけどお約束のようにインストール後はrbenv rehashしておく。</p>

<h2>nginxの設定</h2>

<p>設定ファイルは最低限これくらい書いておけばよさげ</p>

<p>```
upstream unicorn-unix-domain-socket {</p>

<pre><code>    server unix:/var/run/unicorn/unicorn_[app_name].sock fail_timeout=0;
</code></pre>

<p>}</p>

<p>upstream unicorn-tcp {</p>

<pre><code>    server 127.0.0.1:8080;
</code></pre>

<p>}</p>

<p>server {</p>

<pre><code>    listen 80;
    server_name http://hoge;

    root /path/to/app_root/public;

    access_log  /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    location / {
            proxy_pass http://unicorn-tcp;
    }
</code></pre>

<p>}
```</p>

<p>/var/run/unicornディレクトリは前もって作っておく。/tmpとかでも良さげなんだけど、どうなんだろう？</p>

<h2>railsアプリのアップロード</h2>

<p>適当にアップロード。rsyncで適当にやった。</p>

<h2>unicorn起動</h2>

<p><code>sh
$ bundle exec unicorn_rails -D
</code></p>

<p>-Dはデーモンとして起動。configファイルを指定する場合は、-c path/to/config.rbを指定する。</p>

<h2>nginx起動</h2>

<p><code>sh
$ service nginx start
</code></p>

<p>以上でrailsアプリが見れるようになる。</p>
]]></content>
  </entry>
  
</feed>
