<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: PostgreSQL | shigeponが関心のある技術情報など]]></title>
  <link href="http://blog.shigepon.info/blog/categories/postgresql/atom.xml" rel="self"/>
  <link href="http://blog.shigepon.info/"/>
  <updated>2016-01-06T12:19:53+09:00</updated>
  <id>http://blog.shigepon.info/</id>
  <author>
    <name><![CDATA[shigepon]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[ubuntu12.04でpg bulkloadを使う]]></title>
    <link href="http://blog.shigepon.info/blog/2015/09/24/use-pg-bulkload-in-ubuntu-12-dot-04/"/>
    <updated>2015-09-24T08:50:36+09:00</updated>
    <id>http://blog.shigepon.info/blog/2015/09/24/use-pg-bulkload-in-ubuntu-12-dot-04</id>
    <content type="html"><![CDATA[<p>pg_bulkloadを使いたくなるケース</p>

<ul>
<li>大量のデータをインポートしたい</li>
<li>中にはエラーがあるデータがちょこちょこある</li>
</ul>


<p>に当てはまったので、インストールからやってみた。
やったこと順に列記するので最低限の手順ではないと思う。</p>

<p>rpmからインストールする方法でなく、ソースからやってみることにした。
Ubuntu12.04でインストールしたけど、他のバージョンでもほぼ同じだと思う。</p>

<h2>ソースの取得</h2>

<p>まずは最新のstableをgithubから取ってくる。ブログ執筆時はこんな感じ。</p>

<p><code>sh
$ git clone -b VERSION3_1_STABLE https://github.com/ossc-db/pg_bulkload.git
</code></p>

<h2>make(失敗)</h2>

<p>おもむろにmakeしてみると</p>

<p><code>sh
$ cd pg_bulkload
$ make
</code></p>

<p>するとpgxs.xmlが無い！というエラーが出て来た</p>

<p><code>sh
Makefile:17: /usr/lib/postgresql/9.4/lib/pgxs/src/makefiles/pgxs.mk: そのようなファイルやディレクトリはありません
</code></p>

<p>postgresqlは9.2しか入れてないはずなのに何故か9.4のファイルが無いとか言われた。</p>

<h2>試行錯誤(失敗)</h2>

<p>どうもMakefileを調べてみると、ここで出てくるバージョンはpg_configコマンドで取得するバージョンらしい。面倒なので、手動で9.2のファイルを設定するように変更して、さらにpgxs.mkを入れるためにpostgresql-server-dev-9.2をaptitudeでインストールした。</p>

<p>で、おもむろにmakeすると・・・</p>

<p><code>sh
$ sudo make
....
/usr/include/postgresql/libpq-fe.h:547:1: エラー: 不明な型名 ‘pg_int64’ です
/usr/include/postgresql/libpq-fe.h:547:50: エラー: 不明な型名 ‘pg_int64’ です
/usr/include/postgresql/libpq-fe.h:551:1: エラー: 不明な型名 ‘pg_int64’ です
/usr/include/postgresql/libpq-fe.h:553:48: エラー: 不明な型名 ‘pg_int64’ です
make[1]: *** [pg_bulkload.o] エラー 1
make[1]: ディレクトリ `/****/pg_bulkload/bin' から出ます
make: *** [all] エラー 2
</code></p>

<p>と結局エラーが出てしまった。ググって調べるとどうもlibpqのバージョンが関連するらしい。調べてみると</p>

<p><code>sh
$ aptitude show libpq-dev
パッケージ: libpq-dev                    
状態: インストール済み
自動的にインストールされた: いいえ
バージョン: 9.4.0-1.pgdg12.4+1
....
</code></p>

<p>バージョンが9.4になっていたorz。多分だけど、9.2でpg_bulkloadをインストールするにはlibpqをダウングレードしないといけないっぽい。それは面倒なのでpostgresqlのバージョン9.4をインストールすることでバージョンを合わせることにした</p>

<p><code>sh
$ sudo aptitude install postgresql-9.4
$ sudo aptitude install postgresql-server-dev-9.4
</code></p>

<p>インストールの途中でlibpq-devは削除することになった。</p>

<h2>make(成功)</h2>

<p>バージョンを合わせたので、makeしてみると今度はライブラリが足らないというエラーが出た</p>

<p><code>sh
$ sudo make
....
/usr/bin/ld: cannot find -lpam
/usr/bin/ld: cannot find -ledit
collect2: ld はステータス 1 で終了しました
make[1]: *** [pg_bulkload] エラー 1
make[1]: ディレクトリ `/***/pg_bulkload/bin' から出ます
make: *** [all] エラー 2
</code></p>

<p>これはubuntuではlibpam-devとlibedit-devが足らないという意味らしいので、aptitudeからインストールした。</p>

<p><code>sh
$ sudo aptitude install libpam-dev
$ sudo aptitude install libedit-dev
</code></p>

<p>以上の作業でpg_bulkloadのmakeに成功した
<code>sh
$ sudo make
$ sudo make install
</code></p>

<h2>使ってみる</h2>

<p>pg_bulkloadはbinフォルダ内にある。使い方は</p>

<ul>
<li>設定ファイルを書く</li>
<li>csvファイルを用意する</li>
<li>実行する</li>
</ul>


<p>となる。</p>

<h3>設定ファイルを書く</h3>

<p>設定ファイルの例はこんな感じ(下のコマンドの場合、example.ctlで保存しておく)、bin/data内にも例があるので参考になる。
この設定は</p>

<ul>
<li>リダイレクトでcsvファイルを入力する。</li>
<li>リレーションをチェックする。リレーションにミスがある場合はエラーにする</li>
<li>タブ区切り</li>
</ul>


<p><code>
TYPE = CSV
INPUT = stdin
TABLE = table_name
CHECK_CONSTRAINTS = YES
DELIMITER = "   " #タブの場合
WRITER = DIRECT
</code></p>

<p>コマンドはこんな感じ</p>

<p>```sh
$ ./pg_bulkload example.ctl &mdash;dbname db_name  &lt; csv_name.csv
NOTICE: BULK LOAD START
NOTICE: BULK LOAD END</p>

<pre><code>0 Rows skipped.
10 Rows successfully loaded.
0 Rows not loaded due to parse errors.
0 Rows not loaded due to duplicate errors.
0 Rows replaced with new rows.
</code></pre>

<p>```</p>

<p>csvファイルはpsqlで\d table_nameで表示される順序にしておくこと。でないとパースエラーが出る。</p>

<h2>順序が変わる場合</h2>

<p>csvファイル内のフィールド順序をdb内の順序と違うものにしたい場合や、idなど、データを省略したい場合はフィルタを指定出来る。フィルタは</p>

<ul>
<li>db内に関数を作る</li>
<li>設定ファイルでフィルタを指定</li>
</ul>


<p>で設定する。</p>

<p>フィルタの例</p>

<p>```sql
CREATE FUNCTION sample_filter(integer, text, text, real DEFAULT 0.05) RETURNS record</p>

<pre><code>AS $$ SELECT $1 * $4, upper($3) $$
LANGUAGE SQL;
</code></pre>

<p>```</p>

<p>設定ファイル</p>

<p><code>
TYPE = CSV
INPUT = stdin
TABLE = table_name
CHECK_CONSTRAINTS = YES
DELIMITER = "   " #タブの場合
WRITER = DIRECT
FILTER = sample_filter
</code></p>

<h2>出来てない点（追記予定）</h2>

<ul>
<li>MULTI_PROCESS = YESの時に認証失敗する件</li>
</ul>


<p>参考：</p>

<ul>
<li><a href="http://pgbulkload.projects.pgfoundry.org/pg_bulkload.html#filter">pg_bulkload</a></li>
<li><a href="http://www.atmarkit.co.jp/flinux/rensai/linuxtips/a115makeerror.html">makeで「/usr/bin/ld: cannot find」と表示されるときは － ＠IT</a></li>
<li><a href="http://pgfoundry.org/forum/forum.php?thread_id=2851&amp;forum_id=1004&amp;group_id=1000261">pgFoundry: Forum: help</a></li>
<li><a href="https://github.com/ossc-db/pg_bulkload">ossc-db/pg_bulkload</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Djangoで複数データベースを使用する]]></title>
    <link href="http://blog.shigepon.info/blog/2015/07/07/use-multiple-databases-in-django/"/>
    <updated>2015-07-07T12:33:37+09:00</updated>
    <id>http://blog.shigepon.info/blog/2015/07/07/use-multiple-databases-in-django</id>
    <content type="html"><![CDATA[<p>Djangoでは複数データベースを扱える。でも色々コーディングや設定が必要なのでメモしておく。参考：<a href="https://docs.djangoproject.com/en/1.7/topics/db/multi-db/">Multiple databases | Django documentation | Django</a>。対応バージョンはDjango 1.7。使ったデータベースはPostgreSQL。</p>

<h2>settings.py</h2>

<p>settings.pyで複数データベースの接続設定をする</p>

<p>```py settings.py
DATABASES = {</p>

<pre><code>'default': {
    'NAME': 'app_data',
    'ENGINE': 'django.db.backends.postgresql_psycopg2',
    'USER': 'postgres_user',
    'PASSWORD': 's3krit'
},
'users': {
    'NAME': 'user_data',
    'ENGINE': 'django.db.backends.mysql',
    'USER': 'mysql_user',
    'PASSWORD': 'priv4te'
}
</code></pre>

<p>}
```</p>

<p>参考ページのをそのまま使った。さらに追加も出来る。</p>

<h2>ここまでの設定でのマイグレーション</h2>

<p><code>sh
$ python manage.py migrate
</code></p>

<p>だとdefault設定のデータベースへのマイグレーション、</p>

<p><code>sh
$ python manage.py migrate --database=users
</code></p>

<p>とするとusersで設定したデータベースへのマイグレーションとなる。
何も設定していないと、それぞれのデータベースに全アプリケーションの全てのモデルが反映される。</p>

<h2>データベースに保存するアプリ、モデルを限定したい</h2>

<p>ルーティング設定をする。</p>

<p><code>py settings.py
DATABASE_ROUTERS = ['myproject.routers.Router']
</code></p>

<p>settings.pyはこんな感じ。んでmyprojectフォルダにrouters.pyを作成して例えばuserアプリのものだけusersデータベースを使うという設定の場合次のように書く</p>

<p>```py routers.py
class Router(object):</p>

<pre><code>def db_for_read(self, model, **hints):
    #ここでランダムに選択すると、dbの負荷分散っぽいことが出来る
    #例：return random.choice['default','users']
    if model._meta.app_label == "user":
        return "users"
    return "default"
def db_for_write(self, model, **hints):
    if model._meta.app_label == "user":
        return "users"
    return "default"
def allow_relation(self, obj1, obj2, **hints):
    #Trueはリレーションを認める、Falseは認めない、Noneはこのコードでは関知しないという意味
    return None
def allow_migrate(self, db, model):
    #userアプリの場合はusers設定のデータベースへmigrate。
    #他のアプリはusers以外のデータベースへmigrateする設定
    if model._meta.app_label == "user"
        return db == "users":
    else:
        return True
    return False
</code></pre>

<p>```</p>

<p>routers.pyをちゃんと書かないと、色々不具合が出る（例：管理用のモデルがmigrateできないとか）ので気をつけた方が良い。</p>

<p>上に紹介した参考ページには色々コードが書いてあるので、参考になる。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Django1.6.5でPostgreSQLとBootstrap使ったアプリを作ってみた(1):とりあえずDjangoプロジェクトとアプリを作ってみた]]></title>
    <link href="http://blog.shigepon.info/blog/2014/06/18/start-django-project/"/>
    <updated>2014-06-18T12:49:29+09:00</updated>
    <id>http://blog.shigepon.info/blog/2014/06/18/start-django-project</id>
    <content type="html"><![CDATA[<p>Djangoはプロジェクトを作っておいて、アプリ毎に細かく機能を分けて、プロジェクトで統合するみたいな形式を取るみたい。なのでまずはDjangoプロジェクトを作成</p>

<p><code>sh
$ django-admin.py startproject myproject
</code></p>

<p>とすると、カレントフォルダにmyprojectフォルダが出来る。ファイル構成を見ると、</p>

<p>```
myproject/
  manage.py
  myproject/</p>

<pre><code>__init__.py
settings.py
urls.py
wsgi.py
</code></pre>

<p>```</p>

<!-- more -->


<p>となっている。myprojectフォルダ内のファイルに共通設定を書くという感じになりそうだ。PostgreSQLに接続するので、settings.pyを修正</p>

<p>```py
DATABASES = {</p>

<pre><code>'default': {
'ENGINE': 'django.db.backends.postgresql_psycopg2',
'NAME': 'hoge',
'USER': 'username',
'PASSWORD': '******',
'HOST': 'hostname or ip',
'PORT': '5432',
}
</code></pre>

<p>```</p>

<p>あと、psycopg2をインストールしていないので</p>

<p><code>sh
$ sudo pip install psycopg2
</code></p>

<p>とやって</p>

<p><code>sh
$ cd myproject
$ python manage.py syncdb
</code></p>

<p>とやると、hogeに色々テーブルが出来る。INSTALLED_APPSに書いてあるアプリに関するテーブルみたい。初期状態では以下のアプリが入るみたい。</p>

<p><code>
django.contrib.admin - 管理用サイト
django.contrib.auth - 認証
django.contrib.contenttypes - ??
django.contrib.sessions - セッション管理
django.contrib.messages - ??
django.contrib.staticfile - 静的ファイル用アプリ
</code></p>

<p>テーブルは以下のものが作られた
<code>
auth_group
auth_group_permissions
auth_permission
auth_user
auth_user_groups
auth_user_user_permissions
django_admin_log
django_content_type
django_session
</code></p>

<p>あと上のコマンド実行時に、管理者ユーザー作るかどうか聞かれる。とりあえず作った。</p>

<p>DB設定済ませたので、おもむろにアプリ作成。Railsの時と同様に傍聴情報の出力をやってみるか。</p>

<p><code>sh
$ python manage.py startapp bocho
</code></p>

<p>を実行するとbochoフォルダが出来てその中に</p>

<p><code>
bocho/
  __init__.py
  admin.py
  models.py
  tests.py
  views.py
</code></p>

<p>が出来た。とりあえずここまで。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ubuntuでodbcを用いてpostgresqlにアクセスする]]></title>
    <link href="http://blog.shigepon.info/blog/2014/05/12/access-postgresql-through-odbc-ubuntu/"/>
    <updated>2014-05-12T22:11:33+09:00</updated>
    <id>http://blog.shigepon.info/blog/2014/05/12/access-postgresql-through-odbc-ubuntu</id>
    <content type="html"><![CDATA[<p>なでしこ2のテストのためにubuntuにodbcドライバをインストールしたりしたのでメモ</p>

<h2>odbcドライバのインストール</h2>

<p><code>sh
$ sudo aptitude install unixodbc, odbc-postgresql
$ sudo odbcinst -i -d -f /usr/share/psqlodbc/odbcinst.ini.template
$ sudo odbcinst -i -s -l  -n adyoung-pg -f /usr/share/doc/odbc-postgresql/examples/odbc.ini.template
$ vim /etc/odbc.ini
</code></p>

<p>odbc.iniにはサンプルの設定が入っているので、それを参考にしながら設定</p>

<!-- more -->


<h2>odbcアクセスしてみる</h2>

<p><code>sh
$ isql -v DSN (UID (PWD))
</code></p>

<p>でアクセスできる。あとはSQLを入力すれば結果を見たりできる。</p>

<h2>monoを使ってアクセスする場合</h2>

<p>monoというかなでしこ2でアクセスする場合に必要だった。libodbc.soが必要というエラーが出るのでunixodbc-devの追加インストールが必要。インストールすればエラー出ずに動くようになる。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails4でPostgreSQLとBootstrap使ったアプリを作ってみた(4):ビューにBootstrapを使う]]></title>
    <link href="http://blog.shigepon.info/blog/2014/03/14/a-way-of-creating-rails-application4/"/>
    <updated>2014-03-14T09:10:41+09:00</updated>
    <id>http://blog.shigepon.info/blog/2014/03/14/a-way-of-creating-rails-application4</id>
    <content type="html"><![CDATA[<p>参考にした記事URL一覧</p>

<ul>
<li><a href="http://ubiqlog.com/archives/8749">Ruby on Rails 4.0正式リリースとBootstrapの正しい設定法 | ユービックログ研究所</a></li>
<li><a href="http://railscasts.com/episodes/328-twitter-bootstrap-basics?language=ja&amp;view=asciicast">#328 Twitter Bootstrap Basics &ndash; RailsCasts</a></li>
</ul>


<p>今回はそっけない表示画面をそれっぽくするためにビューにBootstrapを当てはめる。</p>

<p>Gemfileを編集</p>

<p><code>
+gem 'less-rails'
+gem 'twitter-bootstrap-rails'
+gem 'execjs'
-gem 'sass-rails'
</code></p>

<!-- more -->


<p>以下のコマンドを実行</p>

<p><code>sh
$ bundle install
$ rails g bootstrap:install
$ rails g bootstrap:layout application
</code></p>

<p>と実行したけど、最後のコマンドはビューを勝手に色々いじるので、しない方が良いかもしれない。上のコマンドを実行すると</p>

<p><code>
app/assets/javascripts/application.js
app/assets/javascripts/bootstrap.js.coffee
app/assets/stylesheets/application.css
app/assets/stylesheets/bootstrap_and_overrides.css.less
</code></p>

<p>が出来る。さて、この状態で出力を見ると、ページ上部がナビゲーションバーで隠れてしまった。
app/assets/stylesheets/bootstrap_and_overrides.css.lessを修正することで対処する</p>

<p>変更前</p>

<p><code>css
@import "twitter/bootstrap/bootstrap";
@import "twitter/bootstrap/responsive";
</code></p>

<p>変更後</p>

<p><code>css
@import "twitter/bootstrap/bootstrap";
body {padding-top:60px;}
@import "twitter/bootstrap/responsive";
</code></p>

<p>これでページが隠れなくなる。レイアウト変更にはapp/views/layouts/application.html.erbを編集する必要がある。</p>
]]></content>
  </entry>
  
</feed>
